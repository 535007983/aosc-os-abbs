pushd "${PKGDIR}"

rm -rf etc/

chmod 4755 opt/vivaldi/vivaldi-sandbox

pushd usr/bin/
ln -sf ../../opt/vivaldi/vivaldi vivaldi-stable
popd

pushd "${PKGDIR}/ffmpeg-codecs"
GNFLAGS=(
    'is_clang=false'
    'symbol_level=0'
    'enable_hevc_demuxing=true'
    'is_component_build=true'
    'is_debug=false'
    'fatal_linker_warnings=false'
    'treat_warnings_as_errors=false'
    'ffmpeg_branding="ChromeOS"'
    'proprietary_codecs=true'
    'linux_use_bundled_binutils=false'
    'use_cups=false'
    'use_gconf=false'
    'use_gnome_keyring=false'
    'use_gold=false'
    'use_sysroot=false'
    'use_gio=false'
    'use_kerberos=false')

touch chrome/test/data/webui/i18n_process_css_test.html

python2 tools/gn/bootstrap/bootstrap.py \
    --gn-gen-args "${GNFLAGS[*]}"
out/Release/gn gen out/Release --args="${GNFLAGS[*]}" \
    --script-executable=/usr/bin/python2

ninja -C out/Release -v media/ffmpeg

install -Dm644 out/Release/libffmpeg.so "${PKGDIR}/opt/vivaldi/libffmpeg.so"

popd

for res in 16 22 24 32 48 64 128 256; do
  install -Dm644 opt/vivaldi/product_logo_${res}.png \
    usr/share/icons/hicolor/${res}x${res}/apps/vivaldi.png
done

install -dm755 usr/share/licenses/vivaldi
strings opt/vivaldi/locales/en-US.pak \
  | tr '\n' ' ' \
  | sed -rne 's/.*(<html lang.*>.*html>).*/\1/p' \
  | w3m -I 'utf-8' -T 'text/html' \
  > usr/share/licenses/vivaldi/eula.txt

popd
