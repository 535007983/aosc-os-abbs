# Variables...
export CC=/usr/bin/gcc
export CXX=/usr/bin/g++
export LANG=en_US.UTF-8
# Generate project build configurations.
#export GYP_DEFINES="TDESKTOP_DISABLE_CRASH_REPORTS,TDESKTOP_DISABLE_AUTOUPDATE,TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME,TDESKTOP_DISABLE_DESKTOP_FILE_GENERATION"
export EXTRA_FLAGS="-Winvalid-pch"
export CPPFLAGS="${CPPFLAGS} ${EXTRA_FLAGS}"
export CXXFLAGS="${CXXFLAGS} ${EXTRA_FLAGS} -fPIC -I/usr/lib/qt5/mkspecs/linux-g++ -ffile-prefix-map=$SRCDIR="
export LDFLAGS="${LDFLAGS}"

cmake -B build -G Ninja . \
        -Ddisable_autoupdate=1 \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release \
        -DTDESKTOP_API_TEST=ON \
        -DDESKTOP_APP_USE_GLIBC_WRAPS=OFF \
        -DDESKTOP_APP_USE_PACKAGED=ON \
        -DDESKTOP_APP_USE_PACKAGED_RLOTTIE=OFF \
        -DDESKTOP_APP_DISABLE_CRASH_REPORTS=ON \
        -DTDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME=ON \
        -DTDESKTOP_DISABLE_DESKTOP_FILE_GENERATION=ON \
        -DTDESKTOP_USE_PACKAGED_TGVOIP=OFF \
        -DDESKTOP_APP_SPECIAL_TARGET="" \
        -DTDESKTOP_LAUNCHER_BASENAME="telegramdesktop"
ninja -C build

# Install.

install -m755 build/bin/telegram-desktop "$PKGDIR/usr/bin/telegram-desktop-bin"

install -d "$PKGDIR/usr/share/applications"
install -m644 lib/xdg/telegramdesktop.desktop "$PKGDIR/usr/share/applications/telegramdesktop.desktop"

install -d "$PKGDIR/usr/share/kservices5"
install -m644 lib/xdg/tg.protocol "$PKGDIR/usr/share/kservices5/tg.protocol"

install -d "$PKGDIR/usr/share/metainfo/"
install -m644 lib/xdg/telegramdesktop.appdata.xml "$PKGDIR/usr/share/metainfo/telegramdesktop.appdata.xml"
for icon_size in 16 32 48 64 128 256 512; do
    icon_dir="$PKGDIR"/usr/share/icons/hicolor/${icon_size}x${icon_size}/apps
    install -d "$icon_dir"
    install -m644 "$SRCDIR"/Telegram/Resources/art/icon${icon_size}.png \
        "$icon_dir"/telegram-desktop.png
done
