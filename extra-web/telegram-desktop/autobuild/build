# Adapted from Arch Linux

# Build static Qt
cd $SRCDIR/../Libraries/QtStatic
./configure -prefix "$SRCDIR/../qt" -release -opensource -confirm-license -qt-zlib \
            -qt-libpng -qt-libjpeg -qt-freetype -qt-harfbuzz -qt-pcre -qt-xcb \
            -qt-xkbcommon-x11 -no-opengl -static -nomake examples -nomake tests
make module-qtbase module-qtimageformats
make module-qtbase-install_subtargets module-qtimageformats-install_subtargets

export PATH="$SRCDIR/../qt/bin:$PATH"

# Build breakpad
cd "$SRCDIR"/../Libraries/breakpad
./configure
make

# Build MetaStyle
mkdir -p "$SRCDIR"/Linux/DebugIntermediateStyle
cd "$SRCDIR"/Linux/DebugIntermediateStyle
qmake CONFIG+=debug ../../Telegram/MetaStyle.pro
make

# Build MetaLang
mkdir -p "$SRCDIR"/Linux/DebugIntermediateLang
cd "$SRCDIR"/Linux/DebugIntermediateLang
qmake CONFIG+=debug ../../Telegram/MetaLang.pro
make

# Build Telegram Desktop
mkdir -p "$SRCDIR"/Linux/ReleaseIntermediate
cd "$SRCDIR"/Linux/ReleaseIntermediate

sed -i "s/-Ofast -flto -fno-strict-aliasing -g/${CPPFLAGS} ${CXXFLAGS}/g" "$SRCDIR"/Telegram/Telegram.pro
sed -i "s/-Ofast -flto -g -rdynamic/${LDFLAGS} -lcrypto/g" "$SRCDIR"/Telegram/Telegram.pro
qmake CONFIG+=release ../../Telegram/Telegram.pro
export pattern="^PRE_TARGETDEPS +="
grep "$pattern" "$SRCDIR"/Telegram/Telegram.pro | sed "s/$pattern//g" | xargs make

qmake CONFIG+=release ../../Telegram/Telegram.pro
make

install -dm755 "$PKGDIR"/usr/bin
install -m755 "$SRCDIR"/Linux/Release/Telegram "$PKGDIR"/usr/bin/telegram-desktop

local icon_size icon_dir
for icon_size in 16 32 48 64 128 256 512; do
	icon_dir="$PKGDIR/usr/share/icons/hicolor/${icon_size}x${icon_size}/apps"

	install -d "$icon_dir"
	install -m644 "$SRCDIR"/Telegram/SourceFiles/art/icon${icon_size}.png "$icon_dir"/telegram-desktop.png
done
