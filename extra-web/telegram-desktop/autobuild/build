# Adapted from Arch Linux
# And telegram-desktop-light as well

# Build static Qt
cd $SRCDIR/../Libraries/QtStatic
./configure -prefix "$SRCDIR/../qt" -release -force-debug-info \
            -opensource -confirm-license -qt-zlib \
            -qt-libpng -qt-libjpeg -qt-freetype -qt-harfbuzz -qt-pcre -qt-xcb \
            -qt-xkbcommon-x11 -no-opengl -static -nomake examples -nomake tests
make module-qtbase module-qtimageformats
make module-qtbase-install_subtargets module-qtimageformats-install_subtargets

export PATH="$SRCDIR/../qt/bin:$PATH"

# Build breakpad
cd "$SRCDIR"/../Libraries/breakpad
./configure
make

# Build codegen_style
mkdir -p "$SRCDIR"/Linux/obj/codegen_style/Release
cd "$SRCDIR"/Linux/obj/codegen_style/Release
qmake CONFIG+=release "$SRCDIR"/Telegram/build/qmake/codegen_style/codegen_style.pro
make
    
# Build codegen_numbers
mkdir -p "$SRCDIR"/Linux/obj/codegen_numbers/Release
cd "$SRCDIR"/Linux/obj/codegen_numbers/Release
qmake CONFIG+=release "$SRCDIR"/Telegram/build/qmake/codegen_numbers/codegen_numbers.pro
make

# Build MetaLang
mkdir -p "$SRCDIR"/Linux/ReleaseIntermediateLang
cd "$SRCDIR"/Linux/ReleaseIntermediateLang
qmake CONFIG+=release "$SRCDIR"/Telegram/MetaLang.pro
make

# Build Telegram Desktop
mkdir -p "$SRCDIR"/Linux/ReleaseIntermediate
cd "$SRCDIR"/Linux/ReleaseIntermediate

../codegen/Release/codegen_style \
    "-I$SRCDIR/Telegram/Resources" \
    "-I$SRCDIR/Telegram/SourceFiles" \
    "-o$SRCDIR/Telegram/GeneratedFiles/styles" \
    all_files.style --rebuild
     
sed -i "s/-Ofast -flto -fno-strict-aliasing -g/${CPPFLAGS} ${CXXFLAGS} -fPIE/g" "$SRCDIR"/Telegram/Telegram.pro
sed -i "s/-Ofast -flto -g -rdynamic/${LDFLAGS} -lcrypto -fPIE -pie/g" "$SRCDIR"/Telegram/Telegram.pro

qmake CONFIG+=release "$SRCDIR"/Telegram/Telegram.pro
../codegen/Release/codegen_numbers \
    "-o$SRCDIR/Telegram/GeneratedFiles" \
    "$SRCDIR/Telegram/Resources/numbers.txt"
    
../ReleaseLang/MetaLang \
    -lang_in "$SRCDIR"/Telegram/Resources/langs/lang.strings \
    -lang_out "$SRCDIR"/Telegram/GeneratedFiles/lang_auto

qmake CONFIG+=release QT_TDESKTOP_PATH="$SRCDIR"/../qt "$SRCDIR"/Telegram/Telegram.pro
make

install -dm755 "$PKGDIR"/usr/bin
install -m755 "$SRCDIR"/Linux/Release/Telegram "$PKGDIR"/usr/bin/telegram-desktop

local icon_size icon_dir
for icon_size in 16 32 48 64 128 256 512; do
	icon_dir="$PKGDIR/usr/share/icons/hicolor/${icon_size}x${icon_size}/apps"

	install -d "$icon_dir"
	install -m644 "$SRCDIR"/Telegram/Resources/art/icon${icon_size}.png "$icon_dir"/telegram-desktop.png
done
