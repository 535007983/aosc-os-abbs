# Bugfixes

# Google Breakpad

git clone --depth 1 https://chromium.googlesource.com/breakpad/breakpad
git clone --depth 1 https://chromium.googlesource.com/linux-syscall-support lss

# Prepare for static Qt build

# Speedy hack for those who has a copy in the abbs tarball cache.
# FIXME: checksum support missing.
cd ..

if [ -e /var/lib/abbs/tarballs/qt-everywhere-opensource-src-5.5.1.tar.gz ]; then
	tar xf /var/lib/abbs/tarballs/qt-everywhere-opensource-src-5.5.1.tar.gz
else
	wget http://download.qt-project.org/official_releases/qt/5.5/5.5.1/single/qt-everywhere-opensource-src-5.5.1.tar.gz
	tar xf qt-everywhere-opensource-src-5.5.1.tar.gz
fi

# Put source in place
if ! [ -d "$SRCDIR"/../Libraries ]; then
	mkdir "$SRCDIR"/../Libraries
	mv "$SRCDIR"/../qt-everywhere-opensource-src-5.5.1 "$SRCDIR"/../Libraries/QtStatic
	cd "$SRCDIR"/../Libraries/QtStatic/qtbase
	patch -p1 -i "$SRCDIR"/Telegram/_qtbase_5_5_1_patch.diff
        patch -Np1 -i "$SRCDIR"/autobuild/patches/qt5-gamma-1.8.patch
fi

ln -s "$SRCDIR"/breakpad "$SRCDIR"/../Libraries/breakpad
ln -s "$SRCDIR"/lss "$SRCDIR"/../Libraries/breakpad/src/third_party/lss

# Terrible hard coding
sed -i 's/CUSTOM_API_ID//g' "$SRCDIR"/Telegram/Telegram.pro
sed -i 's,LIBS += /usr/local/lib/libxkbcommon.a,,g' "$SRCDIR"/Telegram/Telegram.pro
sed -i 's,LIBS += /usr/local/lib/libz.a,LIBS += -lz,g' "$SRCDIR"/Telegram/Telegram.pro

# Adapted from Arch Linux for build definitions
(
	echo 'CONFIG += c++11'
	echo DEFINES += TDESKTOP_DISABLE_AUTOUPDATE
	echo DEFINES += TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
	echo 'INCLUDEPATH += /usr/lib/glib-2.0/include'
	echo 'INCLUDEPATH += /usr/lib/gtk-2.0/include'
	echo 'INCLUDEPATH += /usr/include/opus'
) >> "$SRCDIR"/Telegram/Telegram.pro

cd "$SRCDIR"
