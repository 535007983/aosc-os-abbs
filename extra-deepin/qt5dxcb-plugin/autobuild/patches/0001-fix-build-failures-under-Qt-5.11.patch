From 3214457d622b9ecbea2bcd11d8a3473aac3c0a5a Mon Sep 17 00:00:00 2001
From: Felix Yan <felixonmars@archlinux.org>
Date: Tue, 22 May 2018 20:34:58 +0800
Subject: [PATCH] fix: build failures under Qt 5.11

Change-Id: I35e3163f7410d22ea5aeaec5f4bb294dd5d0e2fd
---
 platformplugin/dplatformintegration.cpp |  5 ++++-
 platformplugin/windoweventhook.cpp      | 12 ++++++++++--
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/platformplugin/dplatformintegration.cpp b/platformplugin/dplatformintegration.cpp
index 4785057..cbb470e 100644
--- a/platformplugin/dplatformintegration.cpp
+++ b/platformplugin/dplatformintegration.cpp
@@ -583,8 +583,11 @@ static void overrideChangeCursor(QPlatformCursor *cursorHandle, QCursor * cursor
         c = it.value();
 #if QT_VERSION < QT_VERSION_CHECK(5, 7, 1)
         w->setCursor(c);
-#else
+#elif QT_VERSION < QT_VERSION_CHECK(5, 11, 0)
         w->setCursor(c, false);
+#else
+        xcb_change_window_attributes(DPlatformIntegration::xcbConnection()->xcb_connection(), w->xcb_window(), XCB_CW_CURSOR, &c);
+        xcb_flush(DPlatformIntegration::xcbConnection()->xcb_connection());
 #endif
     }
 
diff --git a/platformplugin/windoweventhook.cpp b/platformplugin/windoweventhook.cpp
index 2855ba0..69362fe 100644
--- a/platformplugin/windoweventhook.cpp
+++ b/platformplugin/windoweventhook.cpp
@@ -435,12 +435,20 @@ void WindowEventHook::handleXIEnterLeave(xcb_ge_event_t *event)
                     if (!isSet) {
                         QGuiApplicationPrivate::lastCursorPosition = DHighDpi::fromNativePixels(QPointF(root_x, root_y), me->window());
                         me->handleButtonReleaseEvent(event_x, event_y, root_x, root_y,
-                                                     0, modifiers, ev->time);
+                                                     0, modifiers, ev->time
+#if QT_VERSION >= QT_VERSION_CHECK(5, 11, 0)
+                                                     , QEvent::MouseButtonRelease
+#endif
+                                                     );
                     }
                 } else if (isSet) {
                     QGuiApplicationPrivate::lastCursorPosition = DHighDpi::fromNativePixels(QPointF(root_x, root_y), me->window());
                     me->handleButtonPressEvent(event_x, event_y, root_x, root_y,
-                                               0, modifiers, ev->time);
+                                               0, modifiers, ev->time
+#if QT_VERSION >= QT_VERSION_CHECK(5, 11, 0)
+                                               , QEvent::MouseButtonPress
+#endif
+                                               );
                 }
             }
         }
