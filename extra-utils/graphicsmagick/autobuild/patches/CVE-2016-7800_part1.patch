# HG changeset patch
# User Bob Friesenhahn <bfriesen@GraphicsMagick.org>
# Date 1475336055 18000
#      Sat Oct 01 10:34:15 2016 -0500
# Node ID 5c7b6d6094a25e99c57f8b18343914ebfd8213ef
# Parent  623b741873230aaf0aaa767f14f4241f9d56a0f6
Fix unsigned underflow leading to heap overflow when parsing 8BIM chunk.

diff -r 623b74187323 -r 5c7b6d6094a2 ChangeLog
--- a/ChangeLog	Wed Sep 28 22:01:32 2016 -0500
+++ b/ChangeLog	Sat Oct 01 10:34:15 2016 -0500
@@ -1,3 +1,10 @@
+2016-10-01  Bob Friesenhahn  <bfriesen@simple.dallas.tx.us>
+
+	* coders/meta.c (parse8BIM): Fix unsigned underflow leading to
+	heap overflow when parsing 8BIM chunk.  Problem was reported by
+	Marco Grassi via email on October 1, 2016.  Problem was already
+	known (but not fixed) based on comments in the code.
+
 2016-09-05  Bob Friesenhahn  <bfriesen@simple.dallas.tx.us>
 
 	* www/index.rst: Update for 1.3.25 release.
diff -r 623b74187323 -r 5c7b6d6094a2 coders/meta.c
--- a/coders/meta.c	Wed Sep 28 22:01:32 2016 -0500
+++ b/coders/meta.c	Sat Oct 01 10:34:15 2016 -0500
@@ -396,10 +396,17 @@
             {
               if (brkused && next > 0)
                 {
+                  size_t
+                    codes_len;
+
                   char
                     *s = &token[next-1];
 
-                  len -= convertHTMLcodes(s, strlen(s));
+                  codes_len = convertHTMLcodes(s, strlen(s));
+                  if (codes_len > len)
+                    len = 0;
+                  else
+                    len -= codes_len;
                 }
             }
 
@@ -450,7 +457,7 @@
                     next=0;
                     outputlen += len;
                     while (len--)
-                      (void) WriteBlobByte(ofile,token[next++]); /* boom */
+                      (void) WriteBlobByte(ofile,token[next++]);
 
                     if (outputlen & 1)
                       {
@@ -682,10 +689,17 @@
             {
               if (brkused && next > 0)
                 {
+                  size_t
+                    codes_len;
+
                   char
                     *s = &token[next-1];
 
-                  len -= convertHTMLcodes(s, strlen(s));
+                  codes_len = convertHTMLcodes(s, strlen(s));
+                  if (codes_len > len)
+                    len = 0;
+                  else
+                    len -= codes_len;
                 }
             }
 
diff -r 623b74187323 -r 5c7b6d6094a2 www/Changelog.html
--- a/www/Changelog.html	Wed Sep 28 22:01:32 2016 -0500
+++ b/www/Changelog.html	Sat Oct 01 10:34:15 2016 -0500
@@ -35,6 +35,15 @@
 <div class="document">
 
 
+<p>2016-10-01  Bob Friesenhahn  &lt;<a class="reference external" href="mailto:bfriesen&#37;&#52;&#48;simple&#46;dallas&#46;tx&#46;us">bfriesen<span>&#64;</span>simple<span>&#46;</span>dallas<span>&#46;</span>tx<span>&#46;</span>us</a>&gt;</p>
+<blockquote>
+<ul class="simple">
+<li>coders/meta.c (parse8BIM): Fix unsigned underflow leading to
+heap overflow when parsing 8BIM chunk.  Problem was reported by
+Marco Grassi via email on October 1, 2016.  Problem was already
+known (but not fixed) based on comments in the code.</li>
+</ul>
+</blockquote>
 <p>2016-09-05  Bob Friesenhahn  &lt;<a class="reference external" href="mailto:bfriesen&#37;&#52;&#48;simple&#46;dallas&#46;tx&#46;us">bfriesen<span>&#64;</span>simple<span>&#46;</span>dallas<span>&#46;</span>tx<span>&#46;</span>us</a>&gt;</p>
 <blockquote>
 <ul class="simple">
