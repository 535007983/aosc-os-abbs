From c3ae61c04e8235b444caedcd25064fa5af4f4c92 Mon Sep 17 00:00:00 2001
From: Mort Yao <soi@mort.ninja>
Date: Mon, 13 Jan 2020 22:16:33 +0100
Subject: [PATCH] [youtube] remove streams without contentLength (fix #2767)

---
 src/you_get/extractors/youtube.py | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/you_get/extractors/youtube.py b/src/you_get/extractors/youtube.py
index ebb42c69d..07c1382ef 100644
--- a/src/you_get/extractors/youtube.py
+++ b/src/you_get/extractors/youtube.py
@@ -222,7 +222,7 @@ def prepare(self, **kwargs):
                 except:
                     if 'url_encoded_fmt_stream_map' not in video_info:
                         stream_list = json.loads(video_info['player_response'][0])['streamingData']['formats']
-                    else: 
+                    else:
                         stream_list = video_info['url_encoded_fmt_stream_map'][0].split(',')
                     if re.search('([^"]*/base\.js)"', video_page):
                         self.html5player = 'https://www.youtube.com' + re.search('([^"]*/base\.js)"', video_page).group(1)
@@ -451,6 +451,8 @@ def prepare(self, **kwargs):
                                for afmt in video_info['adaptive_fmts'][0].split(',')]
                 else:
                     streams = json.loads(video_info['player_response'][0])['streamingData']['adaptiveFormats']
+                    # streams without contentLength got broken urls, just remove them (#2767)
+                    streams = [stream for stream in streams if 'contentLength' in stream]
                     for stream in streams:
                         stream['itag'] = str(stream['itag'])
                         if 'qualityLabel' in stream:
