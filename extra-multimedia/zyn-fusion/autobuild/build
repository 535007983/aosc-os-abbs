abinfo "Fetching submodules..."
git submodule update --init --recursive --depth=1000
for i in ./autobuild/patches/*.patch; do
    abinfo "Applying ${i}..." && patch -Np1 -i "${i}"
done

abinfo "Fetching ZynaddsubFX v${PKGVER}..."
# Yes, the version is aligned with main Zynaddsubfx
wget --show-progress -q "https://downloads.sourceforge.net/project/zynaddsubfx/zynaddsubfx/${PKGVER}/zynaddsubfx-${PKGVER}.tar.bz2" 
if ! bsdtar -xf zynaddsubfx-${PKGVER}.tar.bz2; then
    aberr "There was a problem fetching & extracting ZynaddsubFX source!"
    exit 4
fi
ZYN_SRCDIR="$(readlink -f zynaddsubfx-${PKGVER}/)"

abinfo "Setting up env variables..."
export VERSION="${PKGVER}"
export BUILD_MODE="release"
WORKDIR="$(pwd)"
abinfo "Initializing build workspace..."
make clean
rm -f package/qml/*.qml || true
abinfo "Building Zyn-Fusion..."
ruby rebuild-fcache.rb
if ! make; then
    aberr "BUILD FAILED!"
    exit 2
fi

abinfo "Cleaning up..."
rm -rf src/mruby-zest/qml/*.qml
# Create an empty MainWindow.qml so that it will load from IR cache
touch src/mruby-zest/qml/MainWindow.qml

abinfo "Building bundled Zynaddsubfx..."
mkdir build-zyn && cd build-zyn
ZYN_BUILDDIR="$(pwd)"
cmake ../zynaddsubfx-${PKGVER} -DGuiModule=zest -DDemoMode="${BUILD_MODE}" -DDefaultOutput=jack -DDefaultInput=jack -DCMAKE_INSTALL_PREFIX=/usr -GNinja
ninja
cd ..

abinfo "Installing contents..."
install -d "$PKGDIR"/opt/zyn-fusion/
install -d "$PKGDIR"/opt/zyn-fusion/{qml,schema,font,ZynAddSubFX.lv2,ZynAddSubFX.lv2presets}
install -Dm644 src/mruby-zest/qml/* "$PKGDIR"/opt/zyn-fusion/qml/
install -Dm755 libzest.so zest "$PKGDIR"/opt/zyn-fusion/
# Bundled ZynaddsubFX
install -Dm755 "${ZYN_BUILDDIR}"/src/Plugin/ZynAddSubFX/lv2/* "${PKGDIR}"/opt/zyn-fusion/ZynAddSubFX.lv2/
install -Dm644 "${ZYN_BUILDDIR}"/src/Plugin/ZynAddSubFX/vst/ZynAddSubFX.so "${PKGDIR}"/opt/zyn-fusion/
install -Dm755 "${ZYN_BUILDDIR}"/src/zynaddsubfx "${PKGDIR}"/opt/zyn-fusion/
cp -ar "${ZYN_SRCDIR}"/instruments/banks "${PKGDIR}"/opt/zyn-fusion/
install -Dm644 "${ZYN_SRCDIR}"/instruments/ZynAddSubFX.lv2presets/* "${PKGDIR}"/opt/zyn-fusion/ZynAddSubFX.lv2presets/
# Bundled UI font and layout JSON
install -Dm644 deps/nanovg/example/*.ttf "$PKGDIR"/opt/zyn-fusion/font/
install -Dm644 src/osc-bridge/schema/test.json "$PKGDIR"/opt/zyn-fusion/schema/
# Next line is proven redundant
# install -Dm644 src/mruby-zest/example/* "$PKGDIR"/opt/zyn-fusion/qml/
mkdir -p "$PKGDIR"/usr/bin/
mkdir -p "$PKGDIR"/usr/lib/lv2
mkdir -p "$PKGDIR"/usr/lib/vst
mkdir -p "$PKGDIR"/usr/share/zynaddsubfx/
# make symlinks
ln -sv /opt/zyn-fusion/ZynAddSubFX.so "$PKGDIR"/usr/lib/vst
ln -sv /opt/zyn-fusion/zest "$PKGDIR"/usr/bin/zyn-fusion
ln -sv /opt/zyn-fusion/zynaddsubfx "$PKGDIR"/usr/bin/zynaddsubfx
ln -sv /opt/zyn-fusion/ZynAddSubFX.lv2/ "$PKGDIR"/usr/lib/lv2/
ln -sv /opt/zyn-fusion/ZynAddSubFX.lv2presets/ "$PKGDIR"/usr/lib/lv2/
ln -sv /opt/zyn-fusion/banks "$PKGDIR"/usr/share/zynaddsubfx/banks
cat << EOF > "$PKGDIR"/opt/zyn-fusion/VERSION
Version ${PKGVER}-AOSC
built on:
$(date -R)
EOF
