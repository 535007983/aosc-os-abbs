From 310ea575ca73b52985812b771515fb44ad4a6292 Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Wed, 15 Jan 2020 18:00:19 +0800
Subject: [PATCH 070/102] lima: add noheap debug option

Disable using heap buffer when set.

Reviewed-by: Vasily Khoruzhick <anarsoul@gmail.com>
Signed-off-by: Qiang Yu <yuq825@gmail.com>
Tested-by: Marge Bot <https://gitlab.freedesktop.org/mesa/mesa/merge_requests/3264>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/merge_requests/3264>
---
 src/gallium/drivers/lima/lima_screen.c | 5 +++++
 src/gallium/drivers/lima/lima_screen.h | 1 +
 2 files changed, 6 insertions(+)

diff --git a/src/gallium/drivers/lima/lima_screen.c b/src/gallium/drivers/lima/lima_screen.c
index 52df2db8792..f627746e72b 100644
--- a/src/gallium/drivers/lima/lima_screen.c
+++ b/src/gallium/drivers/lima/lima_screen.c
@@ -397,6 +397,9 @@ lima_screen_query_info(struct lima_screen *screen)
 
    drmFreeVersion(version);
 
+   if (lima_debug & LIMA_DEBUG_NO_GROW_HEAP)
+      screen->has_growable_heap_buffer = false;
+
    struct drm_lima_get_param param;
 
    memset(&param, 0, sizeof(param));
@@ -464,6 +467,8 @@ static const struct debug_named_value debug_options[] = {
           "print debug info for BO cache" },
         { "notiling", LIMA_DEBUG_NO_TILING,
           "don't use tiled buffers" },
+        { "nogrowheap",   LIMA_DEBUG_NO_GROW_HEAP,
+          "disable growable heap buffer" },
         { NULL }
 };
 
diff --git a/src/gallium/drivers/lima/lima_screen.h b/src/gallium/drivers/lima/lima_screen.h
index 591939da941..fd6ec4e368f 100644
--- a/src/gallium/drivers/lima/lima_screen.h
+++ b/src/gallium/drivers/lima/lima_screen.h
@@ -40,6 +40,7 @@
 #define LIMA_DEBUG_NO_BO_CACHE    (1 << 4)
 #define LIMA_DEBUG_BO_CACHE       (1 << 5)
 #define LIMA_DEBUG_NO_TILING      (1 << 6)
+#define LIMA_DEBUG_NO_GROW_HEAP   (1 << 7)
 
 extern uint32_t lima_debug;
 extern int lima_ctx_num_plb;
-- 
2.24.1

