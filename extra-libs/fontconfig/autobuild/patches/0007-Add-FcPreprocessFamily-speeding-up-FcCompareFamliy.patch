From e124448a539f613a00a88e20e18afbb903f6535d Mon Sep 17 00:00:00 2001
From: Michal Srb <michalsrb@gmail.com>
Date: Tue, 21 Feb 2017 23:14:29 +0200
Subject: [PATCH 07/13] Add FcPreprocessFamily speeding up FcCompareFamliy.

FcPreprocessString calculates hash of the family string to fast reject not matching families.

TODO: Add benchmark numbers.
---
 src/fcmatch.c | 17 +++++++++++++++++
 src/fcobjs.h  |  2 +-
 2 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/src/fcmatch.c b/src/fcmatch.c
index 474aaaf..4e95a86 100644
--- a/src/fcmatch.c
+++ b/src/fcmatch.c
@@ -78,9 +78,26 @@ FcCompareString (FcValue *v1, FcPrepValue *p1, FcValue *v2, FcPrepValue *p2)
     return (double) FcStrCmpIgnoreCase (FcValueString(v1), FcValueString(v2)) != 0;
 }
 
+static FcPrepValue
+FcPreprocessFamily (FcValue *v)
+{
+    FcPrepValue prep;
+    prep.type = FcPrepStrHashIgnoreBlanksAndCase;
+    prep.str_hash = FcStrHashIgnoreBlanksAndCase(FcValueString(v));
+    return prep;
+}
+
 static double
 FcCompareFamily (FcValue *v1, FcPrepValue *p1, FcValue *v2, FcPrepValue *p2)
 {
+    if (p1->type == FcPrepStrHashIgnoreBlanksAndCase &&
+	p2->type == FcPrepStrHashIgnoreBlanksAndCase)
+    {
+	// If hashes are not matching, return fast
+	if (p1->str_hash != p2->str_hash)
+	    return 1.0;
+    }
+
     /* rely on the guarantee in FcPatternObjectAddWithBinding that
      * families are always FcTypeString. */
     const FcChar8* v1_string = FcValueString(v1);
diff --git a/src/fcobjs.h b/src/fcobjs.h
index 5b16c2b..3b1a2e8 100644
--- a/src/fcobjs.h
+++ b/src/fcobjs.h
@@ -22,7 +22,7 @@
  * PERFORMANCE OF THIS SOFTWARE.
  */
 /* DON'T REORDER!  The order is part of the cache signature. */
-FC_OBJECT (FAMILY,		FcTypeString,	FcCompareFamily,	NULL)
+FC_OBJECT (FAMILY,		FcTypeString,	FcCompareFamily,	FcPreprocessFamily)
 FC_OBJECT (FAMILYLANG,		FcTypeString,	NULL,			NULL)
 FC_OBJECT (STYLE,		FcTypeString,	FcCompareString,	FcPreprocessString)
 FC_OBJECT (STYLELANG,		FcTypeString,	NULL,			NULL)
-- 
2.15.1

