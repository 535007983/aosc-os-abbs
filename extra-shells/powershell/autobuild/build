if [[ "${CROSS:-$ARCH}" = "amd64" ]]; then
  DNCRID="linux-x64"
fi
if [[ "${CROSS:-$ARCH}" = "arm64" ]]; then
  PSRID="linux-arm64"
  DNCRID="linux-arm64"
fi
if [[ "${CROSS:-$ARCH}" = "armel" ]]; then
  PSRID="linux-arm32"
  DNCRID="linux-arm"
fi
abinfo "RID is $PSRID"

if [[ "${CROSS:-$ARCH}" != "amd64" ]]; then
abinfo "Download pre-built binaries"
wget "https://github.com/PowerShell/PowerShell/releases/download/v$PKGVER/powershell-$PKGVER-$PSRID.tar.gz"
mkdir -p .bin/pwsh
tar -xf "powershell-$PKGVER-$PSRID.tar.gz" -C .bin/pwsh
PATH="$(pwd)/.bin/pwsh:$PATH"
fi

abinfo "Build PowerShell"
pwsh -c "& {Import-Module \"./build.psm1\"; Start-PSBootstrap; Start-PSBuild -Output \"$PKGDIR/usr/lib/powershell\" -Runtime \"$DNCRID\" -Configuration \"Release\"}"

abinfo "Deploy files"
chmod 0755 "$PKGDIR"/usr/lib/powershell/pwsh
mkdir -p "$PKGDIR"/usr/bin
ln -s /usr/lib/powershell/pwsh "$PKGDIR"/usr/bin/pwsh
