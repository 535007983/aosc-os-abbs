export ATOM_RESOURCE_PATH="$SRCDIR"
export NPM_CONFIG_CACHE="/tmp/atom"

apm install

cd "$SRCDIR"/script
npm install
cd "$SRCDIR"

"$SRCDIR"/script/build

install -d -m 755 "$PKGDIR"/usr/lib
cp -r out/app "$PKGDIR"/usr/lib/atom

install -d -m 755 "$PKGDIR/usr/share/applications"
sed -e "s|<%= appName %>|Atom|" \
    -e "s/<%= description %>/${PKGDES}/" \
    -e "s|<%= installDir %>/share/<%= appFileName %>/atom|electron --app=/usr/lib/atom|" \
    -e "s|<%= iconPath %>|atom|" \
    resources/linux/atom.desktop.in > \
        "$PKGDIR/usr/share/applications/atom.desktop"

for size in 16 24 32 48 64 128 256 512 1024; do
    install -D -m 644 resources/app-icons/stable/png/${size}.png \
        "$PKGDIR"/usr/share/icons/hicolor/${size}x${size}/apps/atom.png
done
ln -sf ../../../share/icons/hicolor/1024x1024/apps/atom.png \
    "$PKGDIR"/usr/lib/atom/resources/atom.png

install -D -m 755 atom.sh "$PKGDIR"/usr/bin/atom

install -d -m 755 "$PKGDIR"/usr/share/doc/$PKGNAME
node -e "require('./script/lib/get-license-text')().then((licenseText) => require('fs').writeFileSync('$PKGDIR/usr/share/doc/$PKGNAME/LICENSE.md', licenseText))"

rm -v "$PKGDIR"/usr/lib/atom/node_modules/.bin/pegjs
find "$PKGDIR"/usr/lib/atom/node_modules \
    -name "*.a" -exec rm -v '{}' \; \
    -or -name "*.bat" -exec rm -v '{}' \; \
    -or -name "*.node" -exec chmod a-x '{}' \; \
    -or -name "benchmark" -prune -exec rm -v -r '{}' \; \
    -or -name "doc" -prune -exec rm -v -r '{}' \; \
    -or -name "html" -prune -exec rm -v -r '{}' \; \
    -or -name "man" -prune -exec rm -v -r '{}' \; \
    -or -path "*/less/gradle" -prune -exec rm -v -r '{}' \; \
    -or -path "*/task-lists/src" -prune -exec rm -v -r '{}' \;
