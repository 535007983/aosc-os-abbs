From c2b1435b5583f78de555b903f7aaab5a22e601eb Mon Sep 17 00:00:00 2001
From: Myles Borins <mylesborins@google.com>
Date: Fri, 13 Oct 2017 01:10:44 -0400
Subject: [PATCH] zlib: gracefully set windowBits from 8 to 9

On 4 April 2017, Node.js versions v4.8.2 and v6.10.2 were
released. These versions bumped the vendored zlib library from
v1.2.8 to v1.2.11 in response to what it describes as low-severity
CVEs. In zlib v1.2.9, a change was made that causes an error to be
raised when a raw deflate stream is initialised with windowBits set
to 8.

In zlib v1.2.9, 8 become an invalid value for this parameter, and Node's zlib
module will crash if you call this:

```
zlib.createDeflateRaw({windowBits: 8})
```

On some versions this crashes Node and you cannot recover from it, while on some
versions it throws an exception. The permessage-deflate library up to
version v0.1.5 does make such a call with no try/catch

This commit reverts to the original behavior of zlib by gracefully changed
windowBits: 8 to windowBits: 9 for raw deflate streams.

PR-URL: https://github.com/nodejs-private/node-private/pull/95
Reviewed-By: Anna Henningsen <anna@addaleax.net>
Reviewed-By: Evan Lucas <evanlucas@me.com>
Reviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>
Reviewed-By: Sam Roberts <vieuxtech@gmail.com>
---
 doc/api/zlib.md                        | 10 +++++++---
 lib/zlib.js                            |  1 +
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/doc/api/zlib.md b/doc/api/zlib.md
index a8aebb585b0..85a3743a9a3 100644
--- a/doc/api/zlib.md
+++ b/doc/api/zlib.md
@@ -458,9 +458,13 @@ added: v0.5.8
 
 Creates and returns a new [DeflateRaw][] object with the given [options][].
 
-*Note*: The zlib library rejects requests for 256-byte windows (i.e.,
-`{ windowBits: 8 }` in `options`). An `Error` will be thrown when creating
-a [DeflateRaw][] object with this specific value of the `windowBits` option.
+*Note*: An upgrade of zlib from 1.2.8 to 1.2.11 changed behavior when windowBits
+is set to 8 for raw deflate streams. zlib does not have a working implementation
+of an 8-bit Window for raw deflate streams and would automatically set windowBit
+to 9 if initially set to 8. Newer versions of zlib will throw an exception.
+This creates a potential DOS vector, and as such the behavior ahs been reverted
+in Node.js 8, 6, and 4. Node.js version 9 and higher will throw when windowBits
+is set to 8.
 
 ## zlib.createGunzip([options])
 <!-- YAML
diff --git a/lib/zlib.js b/lib/zlib.js
index 15886c081ff..7f41200f86b 100644
--- a/lib/zlib.js
+++ b/lib/zlib.js
@@ -563,6 +563,7 @@ function Gunzip(opts) {
 inherits(Gunzip, Zlib);
 
 function DeflateRaw(opts) {
+  if (opts && opts.windowBits === 8) opts.windowBits = 9;
   if (!(this instanceof DeflateRaw))
     return new DeflateRaw(opts);
   Zlib.call(this, opts, constants.DEFLATERAW);
