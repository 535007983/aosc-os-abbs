EXTENSION_DIR=/usr/lib/php/modules
export EXTENSION_DIR
PEAR_INSTALLDIR=/usr/share/pear
export PEAR_INSTALLDIR

mkdir build
pushd build
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cgi \
             --with-readline \
             --enable-pcntl \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             &&

make -j1 &&

popd &&

mkdir build-cgi &&
pushd build-cgi &&
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cli \
             --enable-cgi \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

mkdir build-httpd
pushd build-httpd
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cli \
             --with-apxs2 \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

mkdir build-fpm
pushd build-fpm
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cli \
             --enable-fpm \
             --with-fpm-user=http \
             --with-fpm-group=http \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

mkdir build-embed
pushd build-embed
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cli \
             --enable-embed=shared \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

mkdir build-dbg
pushd build-dbg
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cli \
             --disable-cgi \
             --with-readline \
             --enable-phpdbg \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

mkdir build-pear
pushd build-pear
../configure --srcdir=`pwd`/.. \
             --config-cache \
             --prefix=/usr \
             --sbindir=/usr/bin \
             --sysconfdir=/etc/php \
             --localstatedir=/var \
             --with-layout=GNU \
             --with-config-file-path=/etc/php \
             --with-config-file-scan-dir=/etc/php/conf.d \
             --disable-rpath \
             --mandir=/usr/share/man \
             --without-pear \
             --disable-cgi \
             --with-readline \
             --enable-pcntl \
             --with-pear \
             --enable-bcmath=shared \
             --enable-calendar=shared \
             --enable-dba=shared \
             --enable-exif=shared \
             --enable-ftp=shared \
             --enable-gd-native-ttf \
             --enable-intl=shared \
             --enable-mbstring \
             --enable-opcache \
             --enable-phar=shared \
             --enable-posix=shared \
             --enable-shmop=shared \
             --enable-soap=shared \
             --enable-sockets=shared \
             --enable-sysvmsg=shared \
             --enable-sysvsem=shared \
             --enable-sysvshm=shared \
             --enable-zip=shared \
             --with-bz2=shared \
             --with-curl=shared \
             --with-db4=/usr \
             --with-enchant=shared,/usr \
             --with-fpm-systemd \
             --with-freetype-dir=/usr \
             --with-xpm-dir=/usr \
             --with-gd=shared,/usr \
             --with-gdbm \
             --with-gettext=shared \
             --with-gmp=shared \
             --with-iconv=shared \
             --with-icu-dir=/usr \
             --with-imap-ssl \
             --with-imap=shared \
             --with-jpeg-dir=/usr \
             --with-vpx-dir=/usr \
             --with-ldap=shared \
             --with-ldap-sasl \
             --with-libzip \
             --with-mcrypt=shared \
             --with-mhash \
             --with-mssql=shared \
             --with-mysql-sock=/run/mysqld/mysqld.sock \
             --with-mysql=shared,mysqlnd \
             --with-mysqli=shared,mysqlnd \
             --with-openssl=shared \
             --with-pcre-regex=/usr \
             --with-pdo-mysql=shared,mysqlnd \
             --with-pdo-odbc=shared,unixODBC,/usr \
             --with-pdo-pgsql=shared \
             --with-pdo-sqlite=shared,/usr \
             --with-pgsql=shared \
             --with-png-dir=/usr \
             --with-pspell=shared \
             --with-snmp=shared \
             --with-sqlite3=shared,/usr \
             --without-tidy \
             --with-unixODBC=shared,/usr \
             --with-xmlrpc=shared \
             --with-xsl=shared \
             --with-zlib \
             CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS -flto -O2" LDFLAGS="$LDFLAGS -flto -O2" &&

make -j1 &&

popd

pushd build
make -j1 INSTALL_ROOT=$PKGDIR install
popd

install -d -m755 $PKGDIR/usr/share/pear

install -D -m644 php.ini-production $PKGDIR/etc/php/php.ini
install -d -m755 $PKGDIR/etc/php/conf.d/

rm -f $PKGDIR/usr/lib/php/modules/*.a

install -D -m755 build-cgi/sapi/cgi/php-cgi $PKGDIR/usr/bin/php-cgi

install -D -m755 build-httpd/libs/libphp5.so $PKGDIR/usr/lib/httpd/modules/libphp5.so

install -D -m755 build-fpm/sapi/fpm/php-fpm $PKGDIR/usr/bin/php-fpm
install -D -m644 build-fpm/sapi/fpm/php-fpm.8 $PKGDIR/usr/share/man/man8/php-fpm.8
install -D -m644 build-fpm/sapi/fpm/php-fpm.conf $PKGDIR/etc/php/php-fpm.conf
install -d -m755 $PKGDIR/etc/php/fpm.d

install -D -m755 build-embed/libs/libphp5.so $PKGDIR/usr/lib/libphp5.so
install -D -m644 sapi/embed/php_embed.h $PKGDIR/usr/include/php/sapi/embed/php_embed.h

install -D -m755 build-dbg/sapi/phpdbg/phpdbg $PKGDIR/usr/bin/phpdbg

pushd build-pear
make install-pear INSTALL_ROOT=$PKGDIR
popd

rm -rf $PKGDIR/usr/share/pear/.{channels,depdb,depdblock,filemap,lock,registry}

install -D -m755 build/modules/enchant.so $PKGDIR/usr/lib/php/modules/enchant.so
install -D -m755 build/modules/gd.so $PKGDIR/usr/lib/php/modules/gd.so
install -D -m755 build/modules/intl.so $PKGDIR/usr/lib/php/modules/intl.so
install -D -m755 build/modules/ldap.so $PKGDIR/usr/lib/php/modules/ldap.so
install -D -m755 build/modules/mcrypt.so $PKGDIR/usr/lib/php/modules/mcrypt.so
install -D -m755 build/modules/mssql.so $PKGDIR/usr/lib/php/modules/mssql.so
install -D -m755 build/modules/odbc.so $PKGDIR/usr/lib/php/modules/odbc.so
install -D -m755 build/modules/pdo_odbc.so $PKGDIR/usr/lib/php/modules/pdo_odbc.so
install -D -m755 build/modules/pgsql.so $PKGDIR/usr/lib/php/modules/pgsql.so
install -D -m755 build/modules/pdo_pgsql.so $PKGDIR/usr/lib/php/modules/pdo_pgsql.so
install -D -m755 build/modules/pspell.so $PKGDIR/usr/lib/php/modules/pspell.so
install -D -m755 build/modules/snmp.so $PKGDIR/usr/lib/php/modules/snmp.so
install -D -m755 build/modules/sqlite3.so $PKGDIR/usr/lib/php/modules/sqlite3.so
install -D -m755 build/modules/pdo_sqlite.so $PKGDIR/usr/lib/php/modules/pdo_sqlite.so
install -D -m755 build/modules/xsl.so $PKGDIR/usr/lib/php/modules/xsl.so
