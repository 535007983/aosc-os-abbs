From 4e820fa5b1b2a70dce34ba9aeb3a01ec1f8d189f Mon Sep 17 00:00:00 2001
From: Icenowy Zheng <icenowy@aosc.io>
Date: Wed, 26 Jun 2019 00:44:43 +0800
Subject: [PATCH 3/3] platform/x86: sony-laptop: do ACPI initialization on new
 NC devices

On new VAIO NC devices, the SSDT of them requires the EC region to be
available before the _STA method of them to return available status.

As we probe the _STA of the devices before we make EC region available,
the _INI method is not called, thus the initialization of NC device is
skipped. In these devices, _INI is used to fill the function handle
table, and its skipping will lead sony-laptop to fail to acquire
function handles.

Do the ACPI initialization by ourselves on new NC devices. The existence
of ACPI method SIRN of the NC device can be used to detect whether EC is
needed, because the EC _REG method uses it to notify NC device.

Signed-off-by: Icenowy Zheng <icenowy@aosc.io>
---
 drivers/platform/x86/sony-laptop.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/drivers/platform/x86/sony-laptop.c b/drivers/platform/x86/sony-laptop.c
index 459fb23a3e3d..e0689765cb2f 100644
--- a/drivers/platform/x86/sony-laptop.c
+++ b/drivers/platform/x86/sony-laptop.c
@@ -1555,6 +1555,7 @@ static void sony_nc_function_resume(void)
 static int sony_nc_resume(struct device *dev)
 {
 	struct sony_nc_value *item;
+	acpi_status status;
 
 	for (item = sony_nc_values; item->name; item++) {
 		int ret;
@@ -1575,6 +1576,15 @@ static int sony_nc_resume(struct device *dev)
 			dprintk("ECON Method failed\n");
 	}
 
+	if (acpi_has_method(sony_nc_acpi_handle, "SIRN")) {
+		status = acpi_evaluate_object(sony_nc_acpi_handle,
+					      METHOD_NAME__INI,
+					      NULL, NULL);
+
+		if (ACPI_FAILURE(status)) 
+			dprintk("_INI Method failed\n");
+	}
+
 	if (acpi_has_method(sony_nc_acpi_handle, "SN00"))
 		sony_nc_function_resume();
 
@@ -3209,6 +3219,21 @@ static int sony_nc_add(struct acpi_device *device)
 			dprintk("ECON Method failed\n");
 	}
 
+	if (acpi_has_method(sony_nc_acpi_handle, "SIRN")) {
+		/*
+		 * Workaround hot plugged in device not being
+		 * initialized by the ACPICA code.
+		 */
+		status = acpi_evaluate_object(sony_nc_acpi_handle,
+					      METHOD_NAME__INI,
+					      NULL, NULL);
+
+		if (ACPI_FAILURE(status)) {
+			pr_warn("Unable to call the _INI method.\n");
+			goto outplatform;
+		}
+	}
+
 	if (acpi_has_method(sony_nc_acpi_handle, "SN00")) {
 		dprintk("Doing SNC setup\n");
 		/* retrieve the available handles */
-- 
2.21.0

